Data Transport
==============

Data transport is done on /ht/data.

Request:

    POST /ht/data HTTP/1.1
    Content-Type: application/octet-stream
    Cookie: SESSIONID=%s
    Transfer-Encoding: chunked

Response:

    HTTP/1.1 200 OK
    Content-Type: application/octet-stream
    Transfer-Encoding: chunked

Data transport uses a diagram like protocol.

Each query or response is in a HTTP chunk.

There can be multiple data transport connections between client and server.

## Query

### Query Request

Connect: `c{queryid} {host} tcp {port}`

Disconnect: `q{queryid} {streamid}`

DNS Query: `n{queryid} {host} {A|AAAA|PTR}`

### Query Response

Connect: `.{queryid} {streamid}`

Disconnect: `.{queryid}`

DNS Query: `.{queryid} {result1} {result2} {result3}`

Error: `!{queryid}`

## Transfer

### Upload

Client: `u{queryid} {streamid}`

Server: `.{queryid} {packetid}`

Client: `U{queryid} {payload}`

Server: `.{queryid}`

### Download

Client: `d{queryid} {streamid} {packetid}`

Server:
 - `.{queryid} {payload}`
 - `!{queryid}` for error or connection close

Client: `.{queryid}`

## Note

`queryid` is a random generated string by client.

`streamid` is a string generated by server to indicate a stream.

`packetid` is a hexagon number indicating the packet sequence.

## Shutting down

If there is no data transport connection for 180 seconds. All resources related to this
session will be shut down and recycled.

The client should be aware when /ht/data returns 404. There is a possibility that this
session is shut down for being idle.
